<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ˆ ì‹¤ì‹œê°„ ê±°ë˜ ì„¼í„°</title>
  <link rel="stylesheet" th:href="@{/css/trad-center.css}">
</head>
<body>
<div class="container">
  <h1>ğŸ“Š ì‹¤ì‹œê°„ ê±°ë˜ ì„¼í„°</h1>

  <div class="grid-layout">
    <!-- ì™¼ìª½: ì¢…ëª© ë¦¬ìŠ¤íŠ¸ -->
    <div class="stock-list">
      <h2>ğŸ“‹ ì¢…ëª© ëª©ë¡</h2>
      <table id="stockTable">
        <thead>
        <tr>
          <th>ì¢…ëª© ì½”ë“œ</th>
          <th>ì¢…ëª© ì´ë¦„</th>
          <th>ì¹´í…Œê³ ë¦¬</th>
          <th>í˜„ì¬ê°€</th>
        </tr>
        </thead>
        <tbody>
        <!-- JSë¡œ ë°ì´í„° ì±„ì›€ -->
        </tbody>
      </table>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë³´ìœ  ì¢…ëª© ë° ë§¤ìˆ˜/ë§¤ë„ ë“±ë¡ -->
    <div class="trade-panel">
      <h2>ğŸ’¼ ê±°ë˜ íŒ¨ë„</h2>

      <div id="holdingDisplay">ë³´ìœ  ìˆ˜ëŸ‰: -</div>
      <div id="totalPriceDisplay">ì´ ê±°ë˜ ê¸ˆì•¡: - ì›</div>

      <form id="tradeForm">
        <label for="stockCode">ì¢…ëª© ì½”ë“œ</label>
        <input type="text" id="stockCode" name="stockCode" required readonly>

        <label for="stockName">ì¢…ëª© ì´ë¦„</label>
        <input type="text" id="stockName" name="stockName" required readonly>

        <label for="category">ì¹´í…Œê³ ë¦¬</label>
        <select id="category" name="category" required>
          <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
          <option value="IT">IT</option>
          <option value="ê¸ˆìœµ">ê¸ˆìœµ</option>
          <option value="ì œì¡°">ì œì¡°</option>
          <option value="í—¬ìŠ¤ì¼€ì–´">í—¬ìŠ¤ì¼€ì–´</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>

        <label for="price">ê°€ê²©</label>
        <input type="number" id="price" name="price" required>

        <label for="quantity">ìˆ˜ëŸ‰</label>
        <input type="number" id="quantity" name="quantity" required>

        <label for="tradeType">ê±°ë˜ ìœ í˜•</label>
        <select id="tradeType" name="tradeType" required>
          <option value="BUY">ë§¤ìˆ˜</option>
          <option value="SELL">ë§¤ë„</option>
        </select>

        <button type="submit">ê±°ë˜ ë“±ë¡</button>
      </form>
    </div>
  </div>
</div>

<script th:src="@{/js/jquery-3.7.1.min.js}"></script>
<script>
  // ì‹¤ì‹œê°„ ì¢…ëª© ëª©ë¡ ì¡°íšŒ
  function fetchStockData() {
    $.get("/api/stocks/all", function (stocks) {
      const tbody = $("#stockTable tbody");
      tbody.empty();

      stocks.forEach(stock => {

        const row = `
                    <tr data-code="${stock.stockCode}" data-name="${stock.stockName}" data-price="${stock.currentPrice}">
                        <td>${stock.stockCode}</td>
                        <td>${stock.stockName}</td>
                        <td>${stock["category"]?.categoryName}</td>
                        <td>${stock.currentPrice != null ? stock.currentPrice.toLocaleString() : '-'}</td>
                    </tr>`;
        tbody.append(row);
      });

      $("#stockTable tbody tr").click(function () {
        const code = $(this).data("code");
        const name = $(this).data("name");
        const price = $(this).data("price");

        $("#stockCode").val(code);
        $("#stockName").val(name);
        $("#price").val(price);
        fetchHoldingQuantity(code);
        updateTotalPrice();
      });
    });
  }

  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  function fetchCategory(){
    $.get("/api/categories/all", function(categories){
      const $categorySelect = $('#category');

      console.log("!!!!");

      categories.forEach(category => {
        $categorySelect.append(
                $('<option>', {
                  value: category.categoryId,
                  text: category.categoryName
                })
        )
      })
    });
  }

  // ë³´ìœ  ìˆ˜ëŸ‰ ì¡°íšŒ
  function fetchHoldingQuantity(code) {
    $.get(`/trades/holding/${code}`, function (quantity) {
      $("#holdingDisplay").text(`ë³´ìœ  ìˆ˜ëŸ‰: ${quantity.toLocaleString()} ì£¼`);
      $("#holdingDisplay").data("quantity", quantity);
    });
  }

  // ì´ ê±°ë˜ ê¸ˆì•¡ ê³„ì‚°
  function updateTotalPrice() {
    const price = parseInt($("#price").val()) || 0;
    const qty = parseInt($("#quantity").val()) || 0;
    $("#totalPriceDisplay").text(`ì´ ê±°ë˜ ê¸ˆì•¡: ${(price * qty).toLocaleString()} ì›`);
  }

  // ê±°ë˜ ë“±ë¡
  $("#tradeForm").on("submit", function (e) {
    e.preventDefault();

    const tradeType = $("#tradeType").val();
    const qty = parseInt($("#quantity").val());
    const holding = $("#holdingDisplay").data("quantity") || 0;

    if (tradeType === "SELL" && qty > holding) {
      alert("ë³´ìœ  ìˆ˜ëŸ‰ë³´ë‹¤ ë§ì€ ìˆ˜ëŸ‰ì„ ë§¤ë„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const data = {
      stockCode: $("#stockCode").val(),
      stockName: $("#stockName").val(),
      price: parseInt($("#price").val()),
      quantity: qty,
      tradeType: tradeType
    };

    $.ajax({
      url: "/api/trade",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function () {
        alert("ê±°ë˜ ë“±ë¡ ì™„ë£Œ");
        $("#tradeForm")[0].reset();
        $("#holdingDisplay").text("ë³´ìœ  ìˆ˜ëŸ‰: -");
        $("#totalPriceDisplay").text("ì´ ê±°ë˜ ê¸ˆì•¡: - ì›");
        fetchHoldingQuantity(data.stockCode); // ë³´ìœ  ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
      },
      error: function () {
        alert("ê±°ë˜ ë“±ë¡ ì‹¤íŒ¨");
      }
    });
  });

  $(document).ready(function () {
    fetchStockData();
    fetchCategory();
    setInterval(fetchStockData, 5000);
    $("#price, #quantity").on("input", updateTotalPrice);
  });
</script>
</body>
</html>