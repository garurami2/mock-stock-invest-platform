<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ë§¤ìˆ˜/ë§¤ë„ + ì‹¤ì‹œê°„ ì¢…ëª©</title>
  <link rel="stylesheet" th:href="@{/css/trade-form.css}">
</head>
<body>
<div class="container">
  <h1>ğŸ“Š ì‹¤ì‹œê°„ ì‹œì„¸ & ê±°ë˜ ë“±ë¡</h1>
  <div class="grid-layout">
    <!-- ì¢…ëª© ë¦¬ìŠ¤íŠ¸ -->
    <div class="stock-section">
      <h2>ğŸ“¡ ì¢…ëª© ëª©ë¡</h2>
      <table id="stockTable">
        <thead>
        <tr>
          <th>ì¢…ëª© ì½”ë“œ</th>
          <th>ì¢…ëª© ì´ë¦„</th>
          <th>í˜„ì¬ê°€</th>
        </tr>
        </thead>
        <tbody>
        <!-- JS ë Œë”ë§ -->
        </tbody>
      </table>
    </div>

    <!-- ê±°ë˜ í¼ -->
    <div class="form-section">
      <h2>ğŸ“ ë§¤ìˆ˜ / ë§¤ë„ ë“±ë¡</h2>
      <form id="tradeForm">
        <label for="stockCode">ì¢…ëª© ì½”ë“œ</label>
        <input type="text" id="stockCode" name="stockCode" required readonly>

        <label for="stockName">ì¢…ëª© ì´ë¦„</label>
        <input type="text" id="stockName" name="stockName" required readonly>

        <label for="price">ê°€ê²©</label>
        <input type="number" id="price" name="price" required>

        <label for="quantity">ìˆ˜ëŸ‰</label>
        <input type="number" id="quantity" name="quantity" required>

        <label for="tradeType">ê±°ë˜ ìœ í˜•</label>
        <select id="tradeType" name="tradeType" required>
          <option value="BUY">ë§¤ìˆ˜</option>
          <option value="SELL">ë§¤ë„</option>
        </select>

        <button type="submit">ê±°ë˜ ë“±ë¡</button>
      </form>
      <div id="totalPriceDisplay">ì´ ê±°ë˜ ê¸ˆì•¡: - ì›</div>
      <div id="holdingDisplay">ë³´ìœ  ìˆ˜ëŸ‰: - ì£¼</div>
    </div>
  </div>
</div>

<script th:src="@{/js/jquery-3.7.1.min.js}"></script>
<script>
  function fetchStockData() {
    $.get("/api/stocks", function (stocks) {
      const tbody = $("#stockTable tbody");
      tbody.empty();

      stocks.forEach(stock => {
        const row = `
                    <tr data-code="${stock.stockCode}" data-name="${stock.stockName}" data-price="${stock.currentPrice}">
                        <td>${stock.stockCode}</td>
                        <td>${stock.stockName}</td>
                        <td>${stock.currentPrice.toLocaleString()}</td>
                    </tr>
                `;
        tbody.append(row);
      });

      // í–‰ í´ë¦­ ì‹œ í¼ ìë™ ì…ë ¥
      $("#stockTable tbody tr").click(function () {
        $("#stockCode").val($(this).data("code"));
        $("#stockName").val($(this).data("name"));
        $("#price").val($(this).data("price"));
      });
    });
  }

  // ìë™ ê³„ì‚°
  function updateTotalPrice() {
    const price = parseInt($("#price").val()) || 0;
    const quantity = parseInt($("#quantity").val()) || 0;
    const total = price * quantity;
    $("#totalPriceDisplay").text(`ì´ ê±°ë˜ ê¸ˆì•¡: ${total.toLocaleString()} ì›`);
  }

  // ë³´ìœ  ìˆ˜ëŸ‰ ì¡°íšŒ
  function fetchHoldingQuantity(stockCode) {
    $.get(`/api/trade/holding/${stockCode}`, function (quantity) {
      $("#holdingDisplay").text(`ë³´ìœ  ìˆ˜ëŸ‰: ${quantity.toLocaleString()} ì£¼`);
      $("#holdingDisplay").data("quantity", quantity); // for validation
    });
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  $("#price, #quantity").on("input", updateTotalPrice);

  // ì¢…ëª© í´ë¦­ â†’ ìë™ ì…ë ¥ + ë³´ìœ  ìˆ˜ëŸ‰ ì¡°íšŒ
  $("#stockTable tbody").on("click", "tr", function () {
    const code = $(this).data("code");
    $("#stockCode").val(code);
    $("#stockName").val($(this).data("name"));
    $("#price").val($(this).data("price"));
    updateTotalPrice();
    fetchHoldingQuantity(code);
  });

  $(document).ready(function () {
    fetchStockData();
    setInterval(fetchStockData, 5000);

    $("#tradeForm").on("submit", function (e) {
      const tradeType = $("#tradeType").val();
      const quantity = parseInt($("#quantity").val());
      const holding = $("#holdingDisplay").data("quantity") || 0;

      if (tradeType === "SELL" && quantity > holding) {
        alert(`ë³´ìœ  ìˆ˜ëŸ‰(${holding})ë³´ë‹¤ ë§ì€ ìˆ˜ëŸ‰ì„ ë§¤ë„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        e.preventDefault();
        return;
      }

      e.preventDefault();

      const data = {
        stockCode: $("#stockCode").val(),
        stockName: $("#stockName").val(),
        price: parseInt($("#price").val()),
        quantity: parseInt($("#quantity").val()),
        tradeType: $("#tradeType").val()
      };

      $.ajax({
        url: "/api/trade",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function () {
          alert("ê±°ë˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          $("#tradeForm")[0].reset();
        },
        error: function () {
          alert("ê±°ë˜ ë“±ë¡ ì‹¤íŒ¨!");
        }
      });
    });
  });
</script>
</body>
</html>