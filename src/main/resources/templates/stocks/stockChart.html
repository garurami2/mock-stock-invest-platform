<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stock Price History Chart</title>
  <script th:src="@{/js/chart.js}"></script>
  <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
  <script th:src="@{/js/chartjs-plugin-annotation.min.js}"></script>
</head>
<body style="max-width: 800px; margin: 50px auto; font-family: sans-serif;">
<h2>üìà ÏãúÏÑ∏ ÌûàÏä§ÌÜ†Î¶¨(ÏµúÍ∑º 7Ïùº) (Stock Name: <span id="stock-name">1</span>)</h2>

<label for="stock-select">Ï¢ÖÎ™© ÏÑ†ÌÉù: </label>
<select id="stock-select"></select>

<canvas id="priceChart" style="margin-top: 20px;"></canvas>

<script>
  let chart;


  // 1. Ï¢ÖÎ™© Î∂àÎü¨Ïò§Í∏∞
  fetch('/api/stocks/all')
          .then(res => res.json())
          .then(stocks => {
            const $select = $("#stock-select");
            $.each(stocks, function(i, stock) {
              $select.append($("<option>").val(stock.id).text(stock.stockName));
            });

            // Ï≤´ Î≤àÏß∏ Ï¢ÖÎ™©ÏúºÎ°ú Ï¥àÍ∏∞ Î°úÎìú
            if (stocks.length > 0) {
              $select.val(stocks[0].id);
              loadChartData(stocks[0].id);
            }

            // Ï¢ÖÎ™© ÏÑ†ÌÉùÏãú Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
            $select.on("change", function() {
              loadChartData($(this).val());
            });
          });

  function loadChartData(stockId){
    fetch(`/api/stock/${stockId}/history`)
            .then(response => response.json())
            .then(result => {
              const stockName = result[0].stockName
              const data = result.map(item => ({
                time: new Date(item.recordedAt).toLocaleString('ko-KR', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit'
                }),
                price: item.price
              }));


              const labels = data.map(item => item.time);
              const prices = data.map(item => item.price);

              // document.getElementById("stock-name").textContent = stockName;
              $("#stock-name").text(stockName);

              if(chart){
                // Í∏∞Ï°¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                chart.data.labels = labels;
                chart.data.datasets[0].data = prices;
                chart.update();
              }else{
                chart = new Chart($("#priceChart"), {
                  type: 'line',
                  data: {
                    labels: labels,
                    datasets: [{
                      label: 'Price',
                      data: prices,
                      fill: false,
                      borderColor: 'rgb(75, 192, 192)',
                      tension: 0.1
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      annotation: {
                        annotations: {
                          maxLine: {
                            type: 'line',
                            yMin: Math.max(...prices),
                            yMax: Math.max(...prices),
                            borderColor: 'red',
                            borderWidth: 1,
                            label: {
                              enabled: true,
                              content: 'üìà ÏµúÍ≥†Í∞Ä',
                              position: 'end',
                              backgroundColor: 'red',
                              color: 'white'
                            }
                          },
                          minLine: {
                            type: 'line',
                            yMin: Math.min(...prices),
                            yMax: Math.min(...prices),
                            borderColor: 'blue',
                            borderWidth: 1,
                            label: {
                              enabled: true,
                              content: 'üìâ ÏµúÏ†ÄÍ∞Ä',
                              position: 'start',
                              backgroundColor: 'blue',
                              color: 'white'
                            }
                          }
                        }
                      }
                    },
                    scales: {
                      x: {
                        title: { display: true, text: 'Time' },
                        ticks: { maxRotation: 90, minRotation: 45 }
                      },
                      y: {
                        title: { display: true, text: 'Price (‚Ç©)' },
                        beginAtZero: false
                      }
                    }
                  },
                  plugins: [Chart.registry.getPlugin('annotation')]
                });
              }
            });
  }

</script>
</body>
</html>